<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Tracker Comparator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
    }
    h1, h2 {
      color: #333;
    }
    input[type="file"] {
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      cursor: pointer;
    }
    .group {
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .group h2 {
      margin-top: 0;
      background: #eee;
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .match {
      background-color: #e0ffe0;
    }
    .mismatch {
      background-color: #ffe0e0;
    }
    .missing {
      background-color: #fff0b3;
    }
  </style>
</head>
<body>
  <h1>CSV Tracker Comparator</h1>
  <p>
    Upload the three CSV files below. The tool will group rows by the common project key:
    <br>
    • PNM Tracker: <strong>PROJECT NAME (SPIDAMIN)</strong>
    <br>
    • Trello Tracker: <strong>Card Name</strong>
    <br>
    • SPIDAmin Tracker: <strong>Project</strong>
  </p>
  
  <div>
    <label for="csvPNM"><strong>PNM Project Tracker CSV:</strong></label>
    <input type="file" id="csvPNM" accept=".csv">
  </div>
  <div>
    <label for="csvTrello"><strong>Trello Staking Tracker CSV:</strong></label>
    <input type="file" id="csvTrello" accept=".csv">
  </div>
  <div>
    <label for="csvSpidamin"><strong>SPIDAmin Tracker CSV:</strong></label>
    <input type="file" id="csvSpidamin" accept=".csv">
  </div>
  <button id="compareBtn">Compare Trackers</button>
  
  <div id="output"></div>
  
  <!-- Include Papa Parse from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // Define the key columns for each tracker
    const keyColumns = {
      pnm: "PROJECT NAME (SPIDAMIN)",
      trello: "Card Name",
      spidamin: "Project"
    };

    // Define a list of field mappings for comparison.
    // Each mapping object defines a "label" and then for each tracker
    // the CSV column name that holds the value.
    const fieldMappings = [
      { label: "Project Name", pnm: "PROJECT NAME (SPIDAMIN)", trello: "Card Name", spidamin: "Project" },
      { label: "WO #", pnm: "PNM WO #", trello: "W.O. #" },
      { label: "Attacher WO #", pnm: "ATTACHER WO #", trello: "Attacher W.O. #" },
      { label: "ArcFM Start", pnm: "ARCFM DESIGN START DATE", trello: "ArcFM Start" },
      { label: "ArcFM End", pnm: "ARCFM DESIGN END DATE", trello: "ArcFM Finished" },
      { label: "Staking Count", pnm: "STAKING POLE COUNT", trello: "Staking Site Count" },
      { label: "TT Count", pnm: "TROUBLE TRUCK POLE COUNT", trello: "TT Site Count" },
      { label: "Sent to Scheduling", pnm: "SENT TO SCHEDULING DATE", trello: "Sent to Scheduling" },
      { label: "Added to Schedule", pnm: "ADDED TO SCHEDULE DATE", trello: "Added to Schedule" },
      { label: "Construction Completed", pnm: "PNM CONSTRUCTION COMPLETE DATE", trello: "Construction Completed" },
      { label: "Assigned", pnm: "ADMIN ASSIGNED", spidamin: "Assigned" },
      { label: "Status", pnm: "STATUS", trello: "List Name", spidamin: "Status" }
    ];

    const csvPNMInput = document.getElementById('csvPNM');
    const csvTrelloInput = document.getElementById('csvTrello');
    const csvSpidaminInput = document.getElementById('csvSpidamin');
    const compareBtn = document.getElementById('compareBtn');
    const outputDiv = document.getElementById('output');

    compareBtn.addEventListener('click', () => {
      const filePNM = csvPNMInput.files[0];
      const fileTrello = csvTrelloInput.files[0];
      const fileSpidamin = csvSpidaminInput.files[0];

      if (!filePNM || !fileTrello || !fileSpidamin) {
        alert("Please select all three CSV files.");
        return;
      }

      // Parse all three CSV files
      Papa.parse(filePNM, {
        header: true,
        complete: function(resultsPNM) {
          Papa.parse(fileTrello, {
            header: true,
            complete: function(resultsTrello) {
              Papa.parse(fileSpidamin, {
                header: true,
                complete: function(resultsSpidamin) {
                  processData(resultsPNM.data, resultsTrello.data, resultsSpidamin.data);
                },
                error: function(err) {
                  console.error("Error parsing SPIDAmin CSV:", err);
                  alert("Error parsing SPIDAmin CSV.");
                }
              });
            },
            error: function(err) {
              console.error("Error parsing Trello CSV:", err);
              alert("Error parsing Trello CSV.");
            }
          });
        },
        error: function(err) {
          console.error("Error parsing PNM CSV:", err);
          alert("Error parsing PNM CSV.");
        }
      });
    });

    // Group rows from each tracker by their key (project name)
    function processData(pnmData, trelloData, spidaminData) {
      const groups = {}; // key => { pnm: row or null, trello: row or null, spidamin: row or null }

      // Helper: add a row to the groups object
      function addRow(row, tracker) {
        let keyVal = (row[keyColumns[tracker]] || "").trim();
        if (!keyVal) return; // skip rows without a key
        if (!groups[keyVal]) {
          groups[keyVal] = { pnm: null, trello: null, spidamin: null };
        }
        groups[keyVal][tracker] = row;
      }

      pnmData.forEach(row => addRow(row, "pnm"));
      trelloData.forEach(row => addRow(row, "trello"));
      spidaminData.forEach(row => addRow(row, "spidamin"));

      // Now build the output for each project group.
      displayGroups(groups);
    }

    // Create an HTML table for each project group
    function displayGroups(groups) {
      outputDiv.innerHTML = ""; // clear previous output
      let groupCount = 0;
      for (let key in groups) {
        groupCount++;
        const group = groups[key];
        const groupDiv = document.createElement("div");
        groupDiv.className = "group";
        const header = document.createElement("h2");
        header.textContent = `Project: ${key}`;
        groupDiv.appendChild(header);

        // Build a comparison table for mapped fields
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr>
            <th>Field</th>
            <th>PNM Tracker</th>
            <th>Trello Tracker</th>
            <th>SPIDAmin Tracker</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        fieldMappings.forEach(mapping => {
          const tr = document.createElement("tr");
          // Get values for each tracker
          const pnmVal = group.pnm && mapping.pnm ? (group.pnm[mapping.pnm] || "").trim() : "";
          const trelloVal = group.trello && mapping.trello ? (group.trello[mapping.trello] || "").trim() : "";
          const spidaminVal = group.spidamin && mapping.spidamin ? (group.spidamin[mapping.spidamin] || "").trim() : "";

          // Decide if this row is a match or mismatch.
          // Compare only among trackers that have a value.
          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let allMatch = (values.length <= 1) || values.every(val => val === values[0]);

          // If any tracker is missing this field (i.e. row is missing), mark it.
          let missing = (!group.pnm && mapping.pnm) || (!group.trello && mapping.trello) || (!group.spidamin && mapping.spidamin);

          tr.className = allMatch && !missing ? "match" : "mismatch";

          tr.innerHTML = `<td>${mapping.label}</td>
                          <td>${pnmVal || (mapping.pnm ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${trelloVal || (mapping.trello ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${spidaminVal || (mapping.spidamin ? "<span class='missing'>Not Found</span>" : "")}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        groupDiv.appendChild(table);

        // Optionally, you could also display the full raw row details from each tracker.
        const detailsDiv = document.createElement("div");
        detailsDiv.innerHTML = `<strong>Raw Data:</strong>
          <pre>PNM: ${JSON.stringify(group.pnm, null, 2)}</pre>
          <pre>Trello: ${JSON.stringify(group.trello, null, 2)}</pre>
          <pre>SPIDAmin: ${JSON.stringify(group.spidamin, null, 2)}</pre>`;
        groupDiv.appendChild(detailsDiv);

        outputDiv.appendChild(groupDiv);
      }

      if (groupCount === 0) {
        outputDiv.textContent = "No matching project keys were found.";
      }
    }
  </script>
</body>
</html>
