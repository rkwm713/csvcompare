<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Tracker Comparator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
    }
    h1, h2 {
      color: #333;
    }
    /* Styles for drop zones */
    .drop-zone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
      cursor: pointer;
      color: #666;
    }
    .drop-zone.drag-over {
      background-color: #e8e8e8;
      border-color: #333;
    }
    /* Hide the actual file inputs */
    input[type="file"] {
      display: none;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      cursor: pointer;
    }
    .group {
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .group h2 {
      margin-top: 0;
      background: #eee;
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .match {
      background-color: #e0ffe0;
    }
    .mismatch {
      background-color: #ffe0e0;
    }
    .missing {
      background-color: #fff0b3;
    }
  </style>
</head>
<body>
  <h1>CSV Tracker Comparator</h1>
  <p>
    Upload the three CSV files below by dragging and dropping them (or clicking the area).
    The tool groups rows by the common project key:
    <br>
    • PNM Tracker: <strong>PROJECT NAME (SPIDAMIN)</strong> (headers start at row 2)
    <br>
    • Trello Tracker: <strong>Card Name</strong>
    <br>
    • SPIDAmin Tracker: <strong>Project</strong>
  </p>
  
  <!-- Drop zone for PNM CSV -->
  <div class="drop-zone" id="dropZonePNM">Drag & Drop PNM Project Tracker CSV here or click to select file</div>
  <input type="file" id="csvPNM" accept=".csv">
  
  <!-- Drop zone for Trello CSV -->
  <div class="drop-zone" id="dropZoneTrello">Drag & Drop Trello Staking Tracker CSV here or click to select file</div>
  <input type="file" id="csvTrello" accept=".csv">
  
  <!-- Drop zone for SPIDAmin CSV -->
  <div class="drop-zone" id="dropZoneSpidamin">Drag & Drop SPIDAmin Tracker CSV here or click to select file</div>
  <input type="file" id="csvSpidamin" accept=".csv">
  
  <button id="compareBtn">Compare Trackers</button>
  <button id="downloadCSVBtn" style="display:none;">Download Comparison CSV</button>
  
  <div id="output"></div>
  
  <!-- Include Papa Parse from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // Global file storage
    let filePNMFile = null;
    let fileTrelloFile = null;
    let fileSpidaminFile = null;

    // Define the key columns for each tracker.
    const keyColumns = {
      pnm: "PROJECT NAME (SPIDAMIN)",
      trello: "Card Name",
      spidamin: "Project"
    };

    // Define field mappings for comparison.
    // Each mapping defines a label and the corresponding CSV column names for each tracker.
    const fieldMappings = [
      { label: "Project Name", pnm: "PROJECT NAME (SPIDAMIN)", trello: "Card Name", spidamin: "Project" },
      { label: "WO #", pnm: "PNM WO #", trello: "W.O. #" },
      { label: "Attacher WO #", pnm: "ATTACHER WO #", trello: "Attacher W.O. #" },
      { label: "ArcFM Start", pnm: "ARCFM DESIGN START DATE", trello: "ArcFM Start" },
      { label: "ArcFM End", pnm: "ARCFM DESIGN END DATE", trello: "ArcFM Finished" },
      { label: "Staking Count", pnm: "STAKING POLE COUNT", trello: "Staking Site Count" },
      { label: "TT Count", pnm: "TROUBLE TRUCK POLE COUNT", trello: "TT Site Count" },
      { label: "Sent to Scheduling", pnm: "SENT TO SCHEDULING DATE", trello: "Sent to Scheduling" },
      { label: "Added to Schedule", pnm: "ADDED TO SCHEDULE DATE", trello: "Added to Schedule" },
      { label: "Construction Completed", pnm: "PNM CONSTRUCTION COMPLETE DATE", trello: "Construction Completed" },
      { label: "Assigned", pnm: "ADMIN ASSIGNED", spidamin: "Assigned" },
      { label: "Status", pnm: "STATUS", trello: "List Name", spidamin: "Status" }
    ];

    // Get drop zones and file inputs.
    const dropZonePNM = document.getElementById('dropZonePNM');
    const csvPNMInput = document.getElementById('csvPNM');

    const dropZoneTrello = document.getElementById('dropZoneTrello');
    const csvTrelloInput = document.getElementById('csvTrello');

    const dropZoneSpidamin = document.getElementById('dropZoneSpidamin');
    const csvSpidaminInput = document.getElementById('csvSpidamin');

    const compareBtn = document.getElementById('compareBtn');
    const downloadCSVBtn = document.getElementById('downloadCSVBtn');
    const outputDiv = document.getElementById('output');

    let globalGroups = null; // To store the grouped data for CSV export.

    // --- Drag & Drop & Click-to-Select functionality ---
    function setupDropZone(dropZone, fileInput, fileSetter) {
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files && e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          fileSetter(file);
          dropZone.textContent = file.name;
        }
      });
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          const file = fileInput.files[0];
          fileSetter(file);
          dropZone.textContent = file.name;
        }
      });
    }

    // Setup drop zones for each tracker.
    setupDropZone(dropZonePNM, csvPNMInput, file => filePNMFile = file);
    setupDropZone(dropZoneTrello, csvTrelloInput, file => fileTrelloFile = file);
    setupDropZone(dropZoneSpidamin, csvSpidaminInput, file => fileSpidaminFile = file);

    // --- Compare Button Handler ---
    compareBtn.addEventListener('click', () => {
      if (!filePNMFile || !fileTrelloFile || !fileSpidaminFile) {
        alert("Please select all three CSV files.");
        return;
      }

      // Parse PNM CSV and skip the first row.
      Papa.parse(filePNMFile, {
        header: true,
        beforeFirstChunk: function(chunk) {
          // Remove the first line (row 1) so that headers start at row 2.
          const index = chunk.indexOf("\n");
          if (index !== -1) {
            return chunk.slice(index + 1);
          }
          return chunk;
        },
        complete: function(resultsPNM) {
          Papa.parse(fileTrelloFile, {
            header: true,
            complete: function(resultsTrello) {
              Papa.parse(fileSpidaminFile, {
                header: true,
                complete: function(resultsSpidamin) {
                  processData(resultsPNM.data, resultsTrello.data, resultsSpidamin.data);
                },
                error: function(err) {
                  console.error("Error parsing SPIDAmin CSV:", err);
                  alert("Error parsing SPIDAmin CSV.");
                }
              });
            },
            error: function(err) {
              console.error("Error parsing Trello CSV:", err);
              alert("Error parsing Trello CSV.");
            }
          });
        },
        error: function(err) {
          console.error("Error parsing PNM CSV:", err);
          alert("Error parsing PNM CSV.");
        }
      });
    });

    // Group rows from each tracker by their key (project name).
    function processData(pnmData, trelloData, spidaminData) {
      const groups = {}; // key => { pnm: row or null, trello: row or null, spidamin: row or null }

      function addRow(row, tracker) {
        let keyVal = (row[keyColumns[tracker]] || "").trim();
        if (!keyVal) return; // Skip rows without a key.
        if (!groups[keyVal]) {
          groups[keyVal] = { pnm: null, trello: null, spidamin: null };
        }
        groups[keyVal][tracker] = row;
      }

      pnmData.forEach(row => addRow(row, "pnm"));
      trelloData.forEach(row => addRow(row, "trello"));
      spidaminData.forEach(row => addRow(row, "spidamin"));

      globalGroups = groups;
      displayGroups(groups);
      downloadCSVBtn.style.display = "inline-block";
    }

    // Create an HTML table for each project group.
    function displayGroups(groups) {
      outputDiv.innerHTML = "";
      let groupCount = 0;
      for (let key in groups) {
        groupCount++;
        const group = groups[key];
        const groupDiv = document.createElement("div");
        groupDiv.className = "group";
        const header = document.createElement("h2");
        header.textContent = `Project: ${key}`;
        groupDiv.appendChild(header);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr>
            <th>Field</th>
            <th>PNM Tracker</th>
            <th>Trello Tracker</th>
            <th>SPIDAmin Tracker</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        fieldMappings.forEach(mapping => {
          const tr = document.createElement("tr");
          const pnmVal = group.pnm && mapping.pnm ? (group.pnm[mapping.pnm] || "").trim() : "";
          const trelloVal = group.trello && mapping.trello ? (group.trello[mapping.trello] || "").trim() : "";
          const spidaminVal = group.spidamin && mapping.spidamin ? (group.spidamin[mapping.spidamin] || "").trim() : "";

          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let allMatch = (values.length <= 1) || values.every(val => val === values[0]);

          tr.className = allMatch ? "match" : "mismatch";
          tr.innerHTML = `<td>${mapping.label}</td>
                          <td>${pnmVal || (mapping.pnm ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${trelloVal || (mapping.trello ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${spidaminVal || (mapping.spidamin ? "<span class='missing'>Not Found</span>" : "")}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        groupDiv.appendChild(table);
        outputDiv.appendChild(groupDiv);
      }

      if (groupCount === 0) {
        outputDiv.textContent = "No matching project keys were found.";
      }
    }

    // Helper function to escape CSV values.
    function escapeCSV(value) {
      if (value == null) return "";
      value = value.toString();
      if (value.includes(",") || value.includes("\"") || value.includes("\n")) {
        value = '"' + value.replace(/"/g, '""') + '"';
      }
      return value;
    }

    // CSV export functionality.
    downloadCSVBtn.addEventListener('click', () => {
      if (!globalGroups) return;
      let csvRows = [];
      // Header row.
      csvRows.push(["Project Key", "Field", "PNM Value", "Trello Value", "SPIDAmin Value", "Match"].join(","));

      for (let key in globalGroups) {
        const group = globalGroups[key];
        fieldMappings.forEach(mapping => {
          let pnmVal = group.pnm && mapping.pnm ? (group.pnm[mapping.pnm] || "").trim() : "";
          let trelloVal = group.trello && mapping.trello ? (group.trello[mapping.trello] || "").trim() : "";
          let spidaminVal = group.spidamin && mapping.spidamin ? (group.spidamin[mapping.spidamin] || "").trim() : "";

          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let match = (values.length <= 1) || values.every(val => val === values[0]) ? "Yes" : "No";

          csvRows.push([
            escapeCSV(key),
            escapeCSV(mapping.label),
            escapeCSV(pnmVal),
            escapeCSV(trelloVal),
            escapeCSV(spidaminVal),
            escapeCSV(match)
          ].join(","));
        });
      }

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "tracker_comparison.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
