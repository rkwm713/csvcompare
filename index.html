<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Tracker Comparator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
    }
    h1, h2 {
      color: #333;
    }
    /* Styles for drop zones */
    .drop-zone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
      cursor: pointer;
      color: #666;
    }
    .drop-zone.drag-over {
      background-color: #e8e8e8;
      border-color: #333;
    }
    /* Hide the actual file inputs */
    input[type="file"] {
      display: none;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      cursor: pointer;
    }
    .group {
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .group h2 {
      margin-top: 0;
      background: #eee;
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .match {
      background-color: #e0ffe0;
    }
    .mismatch {
      background-color: #ffe0e0;
    }
    .missing {
      background-color: #fff0b3;
    }
  </style>
</head>
<body>
  <h1>CSV Tracker Comparator</h1>
  <p>
    Upload the three CSV files below by dragging and dropping them (or clicking the area).
    <br>
    <strong>Notes:</strong>
    <ul>
      <li><em>PNM CSV:</em> First row is skipped so headers start at row 2.</li>
      <li><em>Project Key grouping:</em></li>
      <ul>
        <li>PNM Tracker: <strong>PROJECT NAME (SPIDAMIN)</strong></li>
        <li>Trello Tracker: <strong>Card Name</strong></li>
        <li>SPIDAmin Tracker: <strong>Project</strong></li>
      </ul>
      <li><strong>Date Reformatting (Trello):</strong> Any Trello date string like <code>YYYY-MM-DDTHH:MM:SS.sssZ</code> becomes <code>MM-DD-YYYY</code>.</li>
    </ul>
  </p>
  
  <!-- Drop zone for PNM CSV -->
  <div class="drop-zone" id="dropZonePNM">Drag & Drop PNM Project Tracker CSV here or click to select file</div>
  <input type="file" id="csvPNM" accept=".csv">
  
  <!-- Drop zone for Trello CSV -->
  <div class="drop-zone" id="dropZoneTrello">Drag & Drop Trello Staking Tracker CSV here or click to select file</div>
  <input type="file" id="csvTrello" accept=".csv">
  
  <!-- Drop zone for SPIDAmin CSV -->
  <div class="drop-zone" id="dropZoneSpidamin">Drag & Drop SPIDAmin Tracker CSV here or click to select file</div>
  <input type="file" id="csvSpidamin" accept=".csv">
  
  <button id="compareBtn">Compare Trackers</button>
  
  <!-- Two export buttons -->
  <button id="downloadCSVBtn" style="display:none;">Download Comparison CSV</button>
  <button id="downloadSimpleCSVBtn" style="display:none;">Download Simple CSV</button>
  
  <div id="output"></div>
  
  <!-- Include Papa Parse from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    // Global file references
    let filePNMFile = null;
    let fileTrelloFile = null;
    let fileSpidaminFile = null;

    // Define the key columns for each tracker.
    const keyColumns = {
      pnm: "PROJECT NAME (SPIDAMIN)",
      trello: "Card Name",
      spidamin: "Project"
    };

    // Define field mappings for the main "Comparison CSV" export
    // and for the on-screen comparison table.
    const fieldMappings = [
      { label: "Project Name", pnm: "PROJECT NAME (SPIDAMIN)", trello: "Card Name", spidamin: "Project" },
      { label: "WO #", pnm: "PNM WO #", trello: "W.O. #" },
      { label: "Attacher WO #", pnm: "ATTACHER WO #", trello: "Attacher W.O. #" },
      { label: "ArcFM Start", pnm: "ARCFM DESIGN START DATE", trello: "ArcFM Start" },
      { label: "ArcFM End", pnm: "ARCFM DESIGN END DATE", trello: "ArcFM Finished" },
      { label: "Staking Count", pnm: "STAKING POLE COUNT", trello: "Staking Site Count" },
      { label: "TT Count", pnm: "TROUBLE TRUCK POLE COUNT", trello: "TT Site Count" },
      { label: "Sent to Scheduling", pnm: "SENT TO SCHEDULING DATE", trello: "Sent to Scheduling" },
      { label: "Added to Schedule", pnm: "ADDED TO SCHEDULE DATE", trello: "Added to Schedule" },
      { label: "Construction Completed", pnm: "PNM CONSTRUCTION COMPLETE DATE", trello: "Construction Completed" },
      { label: "Assigned", pnm: "ADMIN ASSIGNED", spidamin: "Assigned" },
      { label: "Status", pnm: "STATUS", trello: "List Name", spidamin: "Status" }
    ];

    // Define field mappings for the "Simple CSV" export
    // with columns: CSVs, Project Name, Status, ArcFM Start, ArcFM End, Staking Count,
    //              TT Count, Sent to Scheduling, Added to Schedule, Construction Completed
    const simpleCSVFields = {
      projectName:  { pnm: "PROJECT NAME (SPIDAMIN)", trello: "Card Name", spidamin: "Project" },
      status:       { pnm: "STATUS", trello: "List Name", spidamin: "Status" },
      arcFMStart:   { pnm: "ARCFM DESIGN START DATE", trello: "ArcFM Start" },
      arcFMEnd:     { pnm: "ARCFM DESIGN END DATE", trello: "ArcFM Finished" },
      stakingCount: { pnm: "STAKING POLE COUNT", trello: "Staking Site Count" },
      ttCount:      { pnm: "TROUBLE TRUCK POLE COUNT", trello: "TT Site Count" },
      sentToSched:  { pnm: "SENT TO SCHEDULING DATE", trello: "Sent to Scheduling" },
      addedToSched: { pnm: "ADDED TO SCHEDULE DATE", trello: "Added to Schedule" },
      constComplete:{ pnm: "PNM CONSTRUCTION COMPLETE DATE", trello: "Construction Completed" }
    };

    // --- Utility: date reformat for Trello ---
    // If value is like "YYYY-MM-DDTHH:MM:SS..." -> convert to "MM-DD-YYYY"
    function maybeReformatTrelloDate(val) {
      if (!val) return val;
      // Check if it looks like YYYY-MM-DDT...
      // e.g. "2025-01-31T17:00:00.000Z"
      if (/^\d{4}-\d{2}-\d{2}T/.test(val)) {
        // Extract just the "YYYY-MM-DD" portion
        const datePart = val.split("T")[0]; // "2025-01-31"
        const [yyyy, mm, dd] = datePart.split("-");
        if (yyyy && mm && dd) {
          return `${mm}-${dd}-${yyyy}`;
        }
      }
      return val;
    }

    // --- Get a value from a row, applying Trello date reformat if needed ---
    function getValue(tracker, row, columnName) {
      if (!row || !columnName) return "";
      let val = (row[columnName] || "").trim();
      // If this is Trello data, reformat date if needed
      if (tracker === "trello") {
        val = maybeReformatTrelloDate(val);
      }
      return val;
    }

    // Get references to drop zones, file inputs, and buttons
    const dropZonePNM = document.getElementById('dropZonePNM');
    const csvPNMInput = document.getElementById('csvPNM');

    const dropZoneTrello = document.getElementById('dropZoneTrello');
    const csvTrelloInput = document.getElementById('csvTrello');

    const dropZoneSpidamin = document.getElementById('dropZoneSpidamin');
    const csvSpidaminInput = document.getElementById('csvSpidamin');

    const compareBtn = document.getElementById('compareBtn');
    const downloadCSVBtn = document.getElementById('downloadCSVBtn');
    const downloadSimpleCSVBtn = document.getElementById('downloadSimpleCSVBtn');
    const outputDiv = document.getElementById('output');

    let globalGroups = null; // To store the grouped data for CSV exports.

    // --- Drag & Drop & Click-to-Select Setup ---
    function setupDropZone(dropZone, fileInput, fileSetter) {
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files && e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          fileSetter(file);
          dropZone.textContent = file.name;
        }
      });
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          const file = fileInput.files[0];
          fileSetter(file);
          dropZone.textContent = file.name;
        }
      });
    }

    // Setup drop zones for each tracker
    setupDropZone(dropZonePNM, csvPNMInput, file => filePNMFile = file);
    setupDropZone(dropZoneTrello, csvTrelloInput, file => fileTrelloFile = file);
    setupDropZone(dropZoneSpidamin, csvSpidaminInput, file => fileSpidaminFile = file);

    // --- Compare Button Handler ---
    compareBtn.addEventListener('click', () => {
      if (!filePNMFile || !fileTrelloFile || !fileSpidaminFile) {
        alert("Please select all three CSV files.");
        return;
      }

      // Parse PNM CSV and skip the first row
      Papa.parse(filePNMFile, {
        header: true,
        beforeFirstChunk: function(chunk) {
          // Remove the first line (row 1) so that headers start at row 2.
          const index = chunk.indexOf("\n");
          if (index !== -1) {
            return chunk.slice(index + 1);
          }
          return chunk;
        },
        complete: function(resultsPNM) {
          Papa.parse(fileTrelloFile, {
            header: true,
            complete: function(resultsTrello) {
              Papa.parse(fileSpidaminFile, {
                header: true,
                complete: function(resultsSpidamin) {
                  processData(resultsPNM.data, resultsTrello.data, resultsSpidamin.data);
                },
                error: function(err) {
                  console.error("Error parsing SPIDAmin CSV:", err);
                  alert("Error parsing SPIDAmin CSV.");
                }
              });
            },
            error: function(err) {
              console.error("Error parsing Trello CSV:", err);
              alert("Error parsing Trello CSV.");
            }
          });
        },
        error: function(err) {
          console.error("Error parsing PNM CSV:", err);
          alert("Error parsing PNM CSV.");
        }
      });
    });

    // Group rows from each tracker by their key (project name).
    function processData(pnmData, trelloData, spidaminData) {
      const groups = {}; // key => { pnm: row or null, trello: row or null, spidamin: row or null }

      function addRow(row, tracker) {
        let keyVal = (row[keyColumns[tracker]] || "").trim();
        if (!keyVal) return; // Skip rows without a key
        if (!groups[keyVal]) {
          groups[keyVal] = { pnm: null, trello: null, spidamin: null };
        }
        groups[keyVal][tracker] = row;
      }

      pnmData.forEach(row => addRow(row, "pnm"));
      trelloData.forEach(row => addRow(row, "trello"));
      spidaminData.forEach(row => addRow(row, "spidamin"));

      globalGroups = groups;
      displayGroups(groups);
      // Show export buttons
      downloadCSVBtn.style.display = "inline-block";
      downloadSimpleCSVBtn.style.display = "inline-block";
    }

    // Extract a "Status" to help with sorting
    // Priority: PNM's STATUS -> Trello's List Name -> SPIDAmin's Status
    function getGroupStatus(group) {
      // We'll use getValue to ensure any Trello date reformat logic is not needed for "Status"
      // but it doesn't hurt to keep it consistent
      let s = "";
      if (group.pnm && group.pnm["STATUS"]) {
        s = group.pnm["STATUS"].trim().toLowerCase();
      } else if (group.trello && group.trello["List Name"]) {
        s = group.trello["List Name"].trim().toLowerCase();
      } else if (group.spidamin && group.spidamin["Status"]) {
        s = group.spidamin["Status"].trim().toLowerCase();
      }
      return s;
    }

    // Sort the groups by project key (alphabetically), then by status.
    function sortKeysByProjectAndStatus(groups) {
      let keys = Object.keys(groups);
      keys.sort((a, b) => {
        let aLower = a.toLowerCase();
        let bLower = b.toLowerCase();
        if (aLower < bLower) return -1;
        if (aLower > bLower) return 1;
        // If the project keys are identical, sort by status
        let statusA = getGroupStatus(groups[a]);
        let statusB = getGroupStatus(groups[b]);
        if (statusA < statusB) return -1;
        if (statusA > statusB) return 1;
        return 0;
      });
      return keys;
    }

    // Create an HTML table for each project group, sorted by project key and status.
    function displayGroups(groups) {
      outputDiv.innerHTML = "";
      let keys = sortKeysByProjectAndStatus(groups);

      if (keys.length === 0) {
        outputDiv.textContent = "No matching project keys were found.";
        return;
      }

      keys.forEach(key => {
        const group = groups[key];
        const groupDiv = document.createElement("div");
        groupDiv.className = "group";
        const header = document.createElement("h2");
        header.textContent = `Project: ${key} | Status: ${getGroupStatus(group) || "N/A"}`;
        groupDiv.appendChild(header);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr>
            <th>Field</th>
            <th>PNM Tracker</th>
            <th>Trello Tracker</th>
            <th>SPIDAmin Tracker</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        fieldMappings.forEach(mapping => {
          const tr = document.createElement("tr");

          // Get the three values, applying Trello date reformat if needed
          const pnmVal = getValue("pnm", group.pnm, mapping.pnm);
          const trelloVal = getValue("trello", group.trello, mapping.trello);
          const spidaminVal = getValue("spidamin", group.spidamin, mapping.spidamin);

          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let allMatch = (values.length <= 1) || values.every(val => val === values[0]);

          tr.className = allMatch ? "match" : "mismatch";
          tr.innerHTML = `<td>${mapping.label}</td>
                          <td>${pnmVal || (mapping.pnm ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${trelloVal || (mapping.trello ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${spidaminVal || (mapping.spidamin ? "<span class='missing'>Not Found</span>" : "")}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        groupDiv.appendChild(table);
        outputDiv.appendChild(groupDiv);
      });
    }

    // Helper function to escape CSV values.
    function escapeCSV(value) {
      if (value == null) return "";
      value = value.toString();
      if (value.includes(",") || value.includes("\"") || value.includes("\n")) {
        value = '"' + value.replace(/"/g, '""') + '"';
      }
      return value;
    }

    // --- 1) "Comparison CSV" export (existing) ---
    downloadCSVBtn.addEventListener('click', () => {
      if (!globalGroups) return;
      let csvRows = [];
      // Header row
      csvRows.push(["Project Key", "Field", "PNM Value", "Trello Value", "SPIDAmin Value", "Match"].join(","));

      let keys = sortKeysByProjectAndStatus(globalGroups);

      keys.forEach(key => {
        const group = globalGroups[key];
        fieldMappings.forEach(mapping => {
          let pnmVal = getValue("pnm", group.pnm, mapping.pnm);
          let trelloVal = getValue("trello", group.trello, mapping.trello);
          let spidaminVal = getValue("spidamin", group.spidamin, mapping.spidamin);

          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let match = (values.length <= 1) || values.every(val => val === values[0]) ? "Yes" : "No";

          csvRows.push([
            escapeCSV(key),
            escapeCSV(mapping.label),
            escapeCSV(pnmVal),
            escapeCSV(trelloVal),
            escapeCSV(spidaminVal),
            escapeCSV(match)
          ].join(","));
        });
      });

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "tracker_comparison.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // --- 2) "Simple CSV" export (new) ---
    // Format (3 rows per project: "PNM Value", "Trello Value", "SPIDAmin Value"):
    // CSVs | Project Name | Status | ArcFM Start | ArcFM End | Staking Count | TT Count | Sent to Scheduling | Added to Schedule | Construction Completed
    downloadSimpleCSVBtn.addEventListener('click', () => {
      if (!globalGroups) return;
      let csvRows = [];
      // Header row
      csvRows.push([
        "CSVs",
        "Project Name",
        "Status",
        "ArcFM Start",
        "ArcFM End",
        "Staking Count",
        "TT Count",
        "Sent to Scheduling",
        "Added to Schedule",
        "Construction Completed"
      ].join(","));

      let keys = sortKeysByProjectAndStatus(globalGroups);

      // Helper to get a single field from the correct row
      function getSimpleVal(tracker, row, colName) {
        return getValue(tracker, row, colName); // This applies Trello date reformat
      }

      keys.forEach(key => {
        const group = globalGroups[key];

        // We'll create up to three rows: one for PNM, one for Trello, one for SPIDAmin.
        // If a tracker row is missing, that row will just have blank fields.
        
        // 1) PNM
        if (group.pnm) {
          csvRows.push([
            "PNM Value",
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.projectName.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.status.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.arcFMStart.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.arcFMEnd.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.stakingCount.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.ttCount.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.sentToSched.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.addedToSched.pnm)),
            escapeCSV(getSimpleVal("pnm", group.pnm, simpleCSVFields.constComplete.pnm))
          ].join(","));
        } else {
          // Insert an empty row for PNM
          csvRows.push(["PNM Value","","","","","","","","",""].join(","));
        }

        // 2) Trello
        if (group.trello) {
          csvRows.push([
            "Trello Value",
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.projectName.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.status.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.arcFMStart.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.arcFMEnd.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.stakingCount.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.ttCount.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.sentToSched.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.addedToSched.trello)),
            escapeCSV(getSimpleVal("trello", group.trello, simpleCSVFields.constComplete.trello))
          ].join(","));
        } else {
          csvRows.push(["Trello Value","","","","","","","","",""].join(","));
        }

        // 3) SPIDAmin
        if (group.spidamin) {
          // ArcFM Start/End, etc. typically not in SPIDAmin, so we leave them blank
          csvRows.push([
            "SPIDAmin Value",
            escapeCSV(getSimpleVal("spidamin", group.spidamin, simpleCSVFields.projectName.spidamin)),
            escapeCSV(getSimpleVal("spidamin", group.spidamin, simpleCSVFields.status.spidamin)),
            "", // ArcFM Start
            "", // ArcFM End
            "", // Staking Count
            "", // TT Count
            "", // Sent to Scheduling
            "", // Added to Schedule
            ""  // Construction Completed
          ].join(","));
        } else {
          csvRows.push(["SPIDAmin Value","","","","","","","","",""].join(","));
        }
      });

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "tracker_simple.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
