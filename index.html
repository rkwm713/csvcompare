<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Tracker Comparator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
    }
    h1, h2 {
      color: #333;
    }
    /* Styles for drop zones */
    .drop-zone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
      cursor: pointer;
      color: #666;
    }
    .drop-zone.drag-over {
      background-color: #e8e8e8;
      border-color: #333;
    }
    /* Hide the actual file inputs */
    input[type="file"] {
      display: none;
    }
    button {
      padding: 10px 20px;
      margin-top: 10px;
      cursor: pointer;
    }
    .group {
      border: 1px solid #ccc;
      margin: 20px 0;
      padding: 10px;
      border-radius: 4px;
    }
    .group h2 {
      margin-top: 0;
      background: #eee;
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    .match {
      background-color: #e0ffe0;
    }
    .mismatch {
      background-color: #ffe0e0;
    }
    .missing {
      background-color: #fff0b3;
    }
  </style>
</head>
<body>
  <h1>CSV Tracker Comparator</h1>
  <p>
    Upload the three CSV files below by dragging and dropping them (or clicking the area).  
    <strong>Key Points:</strong>
    <ul>
      <li><em>PNM CSV:</em> The first row is skipped so headers start at row 2.</li>
      <li><em>Excluded Projects:</em> Certain project keys (listed in code) are never included in outputs.</li>
      <li><em>SPIDAmin Email Check:</em> If <code>Assigned</code> in SPIDAmin matches specific emails, show in the new <code>SPIDAmin Assigned Email</code> column in the Simple CSV.</li>
      <li><em>Trello Members Check:</em> If the Trello row's <code>Members</code> contains special usernames, fill in new columns <code>ARCFM TECH</code> or <code>ADMIN ASSIGNED</code> in the Simple CSV.</li>
      <li><em>Date Reformat (Trello only):</em> Any date like <code>YYYY-MM-DDTHH:MM:SS.sssZ</code> becomes <code>MM-DD-YYYY</code>.</li>
    </ul>
  </p>
  
  <!-- Drop zone for PNM CSV -->
  <div class="drop-zone" id="dropZonePNM">Drag & Drop PNM Project Tracker CSV here or click to select file</div>
  <input type="file" id="csvPNM" accept=".csv">
  
  <!-- Drop zone for Trello CSV -->
  <div class="drop-zone" id="dropZoneTrello">Drag & Drop Trello Staking Tracker CSV here or click to select file</div>
  <input type="file" id="csvTrello" accept=".csv">
  
  <!-- Drop zone for SPIDAmin CSV -->
  <div class="drop-zone" id="dropZoneSpidamin">Drag & Drop SPIDAmin Tracker CSV here or click to select file</div>
  <input type="file" id="csvSpidamin" accept=".csv">
  
  <button id="compareBtn">Compare Trackers</button>
  
  <!-- Two export buttons -->
  <button id="downloadCSVBtn" style="display:none;">Download Comparison CSV</button>
  <button id="downloadSimpleCSVBtn" style="display:none;">Download Simple CSV</button>
  
  <div id="output"></div>
  
  <!-- Include Papa Parse from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    ////////////////////////////////////////////////////////////////////////////
    // 1) Excluded project keys (never include them in HTML or CSV outputs).
    ////////////////////////////////////////////////////////////////////////////
    const excludedKeys = new Set([
      "731082029 100 Joe Welch",
      "CCT-2024-040-JB1701069",
      "CCT-2024-046-JB1561890",
      "CCT-2024-124-JB1786597",
      "CCT-2024-215-JB1912165",
      "CCT-2024-230-JB1944935",
      "CCT-2024-261-JB2023537",
      "CCT-2024-409-JB1461698",
      "CCT-2024-414-JB1461698",
      "CCT-2024-417-JB1461698",
      "Delete NOT NEEDED",
      "EZE-2024-002-ABQ 1_14_1",
      "EZE-2024-004-ABQ 1_11_1",
      "EZE-2024-014-ABQ 1_16_1",
      "N100727",
      "N432845",
      "NMSurf-2024-001",
      "PNF-2022-009-CENTRAL-A42-A60",
      "SWF-CRC-2021-001-ABQ-78",
      "TUL19-004",
      "UPN-2023-012",
      "UPNNM18-207",
      "VAL-2024-006-COXCA40",
      "VAL-2024-016 731022143",
      "VAL-2024-021 731022163",
      "VAL-2024-023 731022160",
      "VAL-2024-026 731022167",
      "VAL-2024-029 731022153",
      "VAL-2024-030 731022153",
      "VAL-2024-033 731022155",
      "VAL-2024-035 731022142",
      "VAL-2024-036 731022142",
      "VAL-2024-037",
      "ArcFM Design Checklist",
      "Admin Checklist",
      "Trouble Truck Checklist"
    ].map(s => s.trim())); // Trim to avoid spacing mismatches

    ////////////////////////////////////////////////////////////////////////////
    // 2) If SPIDAmin "Assigned" is any of these emails, show them in new column
    ////////////////////////////////////////////////////////////////////////////
    const spidaminEmailList = new Set([
      "landon.rodgers@txnmenergy.com",
      "hunter.mooney@txnmenergy.com",
      "wesley.simpson@txnmenergy.com",
      "tom.devuyst@pnmresources.com",
      "ryan.miller@txnmenergy.com"
    ]);

    ////////////////////////////////////////////////////////////////////////////
    // 3) If Trello "Members" includes certain usernames, map them to names
    ////////////////////////////////////////////////////////////////////////////
    // For ARCFM TECH
    const arcfmTechMap = {
      "collinsmith94": "COLLIN SMITH",
      "amritthapa11":  "ARMIT THAPA"
    };
    // For ADMIN ASSIGNED
    const adminAssignedMap = {
      "gracebartlett7":   "GRACE BARTLETT",
      "randayshahanson":  "RANDAYSHA HANSON"
    };

    ////////////////////////////////////////////////////////////////////////////
    // 4) Main tracker definitions & date reformat
    ////////////////////////////////////////////////////////////////////////////
    // Define the key columns for each tracker.
    const keyColumns = {
      pnm: "PROJECT NAME (SPIDAMIN)",
      trello: "Card Name",
      spidamin: "Project"
    };

    // Define field mappings for the main "Comparison CSV" export
    // and for the on-screen comparison table.
    const fieldMappings = [
      { label: "Project Name", pnm: "PROJECT NAME (SPIDAMIN)", trello: "Card Name", spidamin: "Project" },
      { label: "WO #", pnm: "PNM WO #", trello: "W.O. #" },
      { label: "Attacher WO #", pnm: "ATTACHER WO #", trello: "Attacher W.O. #" },
      { label: "ArcFM Start", pnm: "ARCFM DESIGN START DATE", trello: "ArcFM Start" },
      { label: "ArcFM End", pnm: "ARCFM DESIGN END DATE", trello: "ArcFM Finished" },
      { label: "Staking Count", pnm: "STAKING POLE COUNT", trello: "Staking Site Count" },
      { label: "TT Count", pnm: "TROUBLE TRUCK POLE COUNT", trello: "TT Site Count" },
      { label: "Sent to Scheduling", pnm: "SENT TO SCHEDULING DATE", trello: "Sent to Scheduling" },
      { label: "Added to Schedule", pnm: "ADDED TO SCHEDULE DATE", trello: "Added to Schedule" },
      { label: "Construction Completed", pnm: "PNM CONSTRUCTION COMPLETE DATE", trello: "Construction Completed" },
      { label: "Assigned", pnm: "ADMIN ASSIGNED", spidamin: "Assigned" },
      { label: "Status", pnm: "STATUS", trello: "List Name", spidamin: "Status" }
    ];

    // Define field mappings for the "Simple CSV" export
    // We'll add new columns at the end for ARCFM TECH, ADMIN ASSIGNED, and SPIDAmin Email
    const simpleCSVFields = {
      projectName:  { pnm: "PROJECT NAME (SPIDAMIN)", trello: "Card Name", spidamin: "Project" },
      status:       { pnm: "STATUS", trello: "List Name", spidamin: "Status" },
      arcFMStart:   { pnm: "ARCFM DESIGN START DATE", trello: "ArcFM Start" },
      arcFMEnd:     { pnm: "ARCFM DESIGN END DATE", trello: "ArcFM Finished" },
      stakingCount: { pnm: "STAKING POLE COUNT", trello: "Staking Site Count" },
      ttCount:      { pnm: "TROUBLE TRUCK POLE COUNT", trello: "TT Site Count" },
      sentToSched:  { pnm: "SENT TO SCHEDULING DATE", trello: "Sent to Scheduling" },
      addedToSched: { pnm: "ADDED TO SCHEDULE DATE", trello: "Added to Schedule" },
      constComplete:{ pnm: "PNM CONSTRUCTION COMPLETE DATE", trello: "Construction Completed" }
    };

    // If we see a Trello date like YYYY-MM-DDTHH:MM:SS.sssZ, convert to MM-DD-YYYY
    function maybeReformatTrelloDate(val) {
      if (!val) return val;
      if (/^\d{4}-\d{2}-\d{2}T/.test(val)) {
        const datePart = val.split("T")[0]; // e.g. "2025-01-31"
        const [yyyy, mm, dd] = datePart.split("-");
        if (yyyy && mm && dd) {
          return `${mm}-${dd}-${yyyy}`;
        }
      }
      return val;
    }

    // Helper: get a value from a row, applying Trello date reformat if needed
    function getValue(tracker, row, columnName) {
      if (!row || !columnName) return "";
      let val = (row[columnName] || "").trim();
      if (tracker === "trello") {
        val = maybeReformatTrelloDate(val);
      }
      return val;
    }

    ////////////////////////////////////////////////////////////////////////////
    // 5) Drag & Drop Setup
    ////////////////////////////////////////////////////////////////////////////
    const dropZonePNM = document.getElementById('dropZonePNM');
    const csvPNMInput = document.getElementById('csvPNM');

    const dropZoneTrello = document.getElementById('dropZoneTrello');
    const csvTrelloInput = document.getElementById('csvTrello');

    const dropZoneSpidamin = document.getElementById('dropZoneSpidamin');
    const csvSpidaminInput = document.getElementById('csvSpidamin');

    function setupDropZone(dropZone, fileInput, fileSetter) {
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files && e.dataTransfer.files.length) {
          const file = e.dataTransfer.files[0];
          fileSetter(file);
          dropZone.textContent = file.name;
        }
      });
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          const file = fileInput.files[0];
          fileSetter(file);
          dropZone.textContent = file.name;
        }
      });
    }

    setupDropZone(dropZonePNM, csvPNMInput, file => filePNMFile = file);
    setupDropZone(dropZoneTrello, csvTrelloInput, file => fileTrelloFile = file);
    setupDropZone(dropZoneSpidamin, csvSpidaminInput, file => fileSpidaminFile = file);

    ////////////////////////////////////////////////////////////////////////////
    // 6) Parsing & Grouping
    ////////////////////////////////////////////////////////////////////////////
    let filePNMFile = null;
    let fileTrelloFile = null;
    let fileSpidaminFile = null;

    const compareBtn = document.getElementById('compareBtn');
    const downloadCSVBtn = document.getElementById('downloadCSVBtn');
    const downloadSimpleCSVBtn = document.getElementById('downloadSimpleCSVBtn');
    const outputDiv = document.getElementById('output');

    let globalGroups = null; // store grouped data for exports

    compareBtn.addEventListener('click', () => {
      if (!filePNMFile || !fileTrelloFile || !fileSpidaminFile) {
        alert("Please select all three CSV files.");
        return;
      }

      // Parse PNM CSV, skipping the first row
      Papa.parse(filePNMFile, {
        header: true,
        beforeFirstChunk: function(chunk) {
          const index = chunk.indexOf("\n");
          if (index !== -1) {
            return chunk.slice(index + 1);
          }
          return chunk;
        },
        complete: function(resultsPNM) {
          Papa.parse(fileTrelloFile, {
            header: true,
            complete: function(resultsTrello) {
              Papa.parse(fileSpidaminFile, {
                header: true,
                complete: function(resultsSpidamin) {
                  processData(resultsPNM.data, resultsTrello.data, resultsSpidamin.data);
                },
                error: function(err) {
                  console.error("Error parsing SPIDAmin CSV:", err);
                  alert("Error parsing SPIDAmin CSV.");
                }
              });
            },
            error: function(err) {
              console.error("Error parsing Trello CSV:", err);
              alert("Error parsing Trello CSV.");
            }
          });
        },
        error: function(err) {
          console.error("Error parsing PNM CSV:", err);
          alert("Error parsing PNM CSV.");
        }
      });
    });

    function processData(pnmData, trelloData, spidaminData) {
      const groups = {}; // key => { pnm: row or null, trello: row or null, spidamin: row or null }

      function addRow(row, tracker) {
        let keyVal = (row[keyColumns[tracker]] || "").trim();
        if (!keyVal) return;
        if (!groups[keyVal]) {
          groups[keyVal] = { pnm: null, trello: null, spidamin: null };
        }
        groups[keyVal][tracker] = row;
      }

      pnmData.forEach(row => addRow(row, "pnm"));
      trelloData.forEach(row => addRow(row, "trello"));
      spidaminData.forEach(row => addRow(row, "spidamin"));

      // Save globally
      globalGroups = groups;
      displayGroups(groups);
      downloadCSVBtn.style.display = "inline-block";
      downloadSimpleCSVBtn.style.display = "inline-block";
    }

    ////////////////////////////////////////////////////////////////////////////
    // 7) Sorting & Display
    ////////////////////////////////////////////////////////////////////////////
    function getGroupStatus(group) {
      // For sorting by status if keys are identical
      if (group.pnm && group.pnm["STATUS"]) {
        return group.pnm["STATUS"].trim().toLowerCase();
      } else if (group.trello && group.trello["List Name"]) {
        return group.trello["List Name"].trim().toLowerCase();
      } else if (group.spidamin && group.spidamin["Status"]) {
        return group.spidamin["Status"].trim().toLowerCase();
      }
      return "";
    }

    function sortKeysByProjectAndStatus(groups) {
      let keys = Object.keys(groups);
      keys.sort((a, b) => {
        const aLower = a.toLowerCase();
        const bLower = b.toLowerCase();
        if (aLower < bLower) return -1;
        if (aLower > bLower) return 1;
        // If the project keys are identical, sort by status
        const statusA = getGroupStatus(groups[a]);
        const statusB = getGroupStatus(groups[b]);
        if (statusA < statusB) return -1;
        if (statusA > statusB) return 1;
        return 0;
      });
      return keys;
    }

    // Display the HTML comparison, skipping excluded keys
    function displayGroups(groups) {
      outputDiv.innerHTML = "";
      let allKeys = sortKeysByProjectAndStatus(groups);

      let displayedCount = 0;
      for (const key of allKeys) {
        if (excludedKeys.has(key)) {
          // Skip
          continue;
        }
        displayedCount++;
        const group = groups[key];

        const groupDiv = document.createElement("div");
        groupDiv.className = "group";
        const header = document.createElement("h2");
        header.textContent = `Project: ${key} | Status: ${getGroupStatus(group) || "N/A"}`;
        groupDiv.appendChild(header);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr>
            <th>Field</th>
            <th>PNM Tracker</th>
            <th>Trello Tracker</th>
            <th>SPIDAmin Tracker</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        fieldMappings.forEach(mapping => {
          const tr = document.createElement("tr");
          const pnmVal      = getValue("pnm", group.pnm, mapping.pnm);
          const trelloVal   = getValue("trello", group.trello, mapping.trello);
          const spidaminVal = getValue("spidamin", group.spidamin, mapping.spidamin);

          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let allMatch = (values.length <= 1) || values.every(val => val === values[0]);

          tr.className = allMatch ? "match" : "mismatch";
          tr.innerHTML = `<td>${mapping.label}</td>
                          <td>${pnmVal || (mapping.pnm ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${trelloVal || (mapping.trello ? "<span class='missing'>Not Found</span>" : "")}</td>
                          <td>${spidaminVal || (mapping.spidamin ? "<span class='missing'>Not Found</span>" : "")}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        groupDiv.appendChild(table);
        outputDiv.appendChild(groupDiv);
      }

      if (displayedCount === 0) {
        outputDiv.textContent = "No matching project keys were found (or all are excluded).";
      }
    }

    ////////////////////////////////////////////////////////////////////////////
    // 8) CSV Exports
    ////////////////////////////////////////////////////////////////////////////
    function escapeCSV(value) {
      if (value == null) return "";
      value = value.toString();
      if (value.includes(",") || value.includes("\"") || value.includes("\n")) {
        value = '"' + value.replace(/"/g, '""') + '"';
      }
      return value;
    }

    // --- 8a) Comparison CSV (existing format) ---
    downloadCSVBtn.addEventListener('click', () => {
      if (!globalGroups) return;
      let csvRows = [];
      csvRows.push(["Project Key","Field","PNM Value","Trello Value","SPIDAmin Value","Match"].join(","));

      let allKeys = sortKeysByProjectAndStatus(globalGroups);
      for (const key of allKeys) {
        if (excludedKeys.has(key)) continue; // skip
        const group = globalGroups[key];
        fieldMappings.forEach(mapping => {
          const pnmVal      = getValue("pnm", group.pnm, mapping.pnm);
          const trelloVal   = getValue("trello", group.trello, mapping.trello);
          const spidaminVal = getValue("spidamin", group.spidamin, mapping.spidamin);

          let values = [];
          if (pnmVal) values.push(pnmVal);
          if (trelloVal) values.push(trelloVal);
          if (spidaminVal) values.push(spidaminVal);
          let match = (values.length <= 1) || values.every(val => val === values[0]) ? "Yes" : "No";

          csvRows.push([
            escapeCSV(key),
            escapeCSV(mapping.label),
            escapeCSV(pnmVal),
            escapeCSV(trelloVal),
            escapeCSV(spidaminVal),
            escapeCSV(match)
          ].join(","));
        });
      }

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "tracker_comparison.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // --- 8b) Simple CSV (3 rows per project + new columns) ---
    // Columns: 
    // 1) CSVs
    // 2) Project Name
    // 3) Status
    // 4) ArcFM Start
    // 5) ArcFM End
    // 6) Staking Count
    // 7) TT Count
    // 8) Sent to Scheduling
    // 9) Added to Schedule
    // 10) Construction Completed
    // 11) ARCFM TECH
    // 12) ADMIN ASSIGNED
    // 13) SPIDAmin Assigned Email
    downloadSimpleCSVBtn.addEventListener('click', () => {
      if (!globalGroups) return;
      let csvRows = [];
      csvRows.push([
        "CSVs",
        "Project Name",
        "Status",
        "ArcFM Start",
        "ArcFM End",
        "Staking Count",
        "TT Count",
        "Sent to Scheduling",
        "Added to Schedule",
        "Construction Completed",
        "ARCFM TECH",
        "ADMIN ASSIGNED",
        "SPIDAmin Assigned Email"
      ].join(","));

      let allKeys = sortKeysByProjectAndStatus(globalGroups);

      // Helper to retrieve the correct field
      function getSimpleVal(tracker, row, colName) {
        return getValue(tracker, row, colName);
      }

      // For Trello "Members" => ARCFM TECH / ADMIN ASSIGNED
      function parseTrelloMembers(row) {
        if (!row || !row["Members"]) return { arcfmTech: "", adminAssigned: "" };
        let members = row["Members"].toLowerCase(); // check substring
        let arcfmTechList = [];
        for (const [username, fullName] of Object.entries(arcfmTechMap)) {
          if (members.includes(username)) {
            arcfmTechList.push(fullName);
          }
        }
        let adminAssignedList = [];
        for (const [username, fullName] of Object.entries(adminAssignedMap)) {
          if (members.includes(username)) {
            adminAssignedList.push(fullName);
          }
        }
        return {
          arcfmTech: arcfmTechList.join(", "),
          adminAssigned: adminAssignedList.join(", ")
        };
      }

      // For SPIDAmin "Assigned" => check if in spidaminEmailList
      function parseSpidaminAssigned(row) {
        if (!row || !row["Assigned"]) return "";
        let assignedVal = row["Assigned"].trim().toLowerCase();
        // Our spidaminEmailList is lower-case?
        // We'll do an exact match ignoring case
        for (const email of spidaminEmailList) {
          if (assignedVal === email.toLowerCase()) {
            return email; // Return the original or the matching set item
          }
        }
        return "";
      }

      for (const key of allKeys) {
        if (excludedKeys.has(key)) continue; // skip
        const group = globalGroups[key];

        // We build up to 3 rows: PNM Value, Trello Value, SPIDAmin Value
        // 1) PNM
        {
          const rowPNM = group.pnm;
          csvRows.push([
            "PNM Value",
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.projectName.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.status.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.arcFMStart.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.arcFMEnd.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.stakingCount.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.ttCount.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.sentToSched.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.addedToSched.pnm)),
            escapeCSV(getSimpleVal("pnm", rowPNM, simpleCSVFields.constComplete.pnm)),
            "", // ARCFM TECH (PNM doesn't define)
            "", // ADMIN ASSIGNED (PNM doesn't define)
            ""  // SPIDAmin Assigned Email
          ].join(","));
        }

        // 2) Trello
        {
          const rowTrello = group.trello;
          const { arcfmTech, adminAssigned } = parseTrelloMembers(rowTrello);
          csvRows.push([
            "Trello Value",
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.projectName.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.status.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.arcFMStart.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.arcFMEnd.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.stakingCount.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.ttCount.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.sentToSched.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.addedToSched.trello)),
            escapeCSV(getSimpleVal("trello", rowTrello, simpleCSVFields.constComplete.trello)),
            escapeCSV(arcfmTech),       // ARCFM TECH
            escapeCSV(adminAssigned),   // ADMIN ASSIGNED
            ""                          // SPIDAmin Assigned Email
          ].join(","));
        }

        // 3) SPIDAmin
        {
          const rowSpidamin = group.spidamin;
          const assignedEmail = parseSpidaminAssigned(rowSpidamin);
          // Typically we don't have ArcFM or scheduling fields in SPIDAmin
          csvRows.push([
            "SPIDAmin Value",
            escapeCSV(getSimpleVal("spidamin", rowSpidamin, simpleCSVFields.projectName.spidamin)),
            escapeCSV(getSimpleVal("spidamin", rowSpidamin, simpleCSVFields.status.spidamin)),
            "", // ArcFM Start
            "", // ArcFM End
            "", // Staking Count
            "", // TT Count
            "", // Sent to Scheduling
            "", // Added to Schedule
            "", // Construction Completed
            "", // ARCFM TECH
            "", // ADMIN ASSIGNED
            escapeCSV(assignedEmail) // SPIDAmin Assigned Email
          ].join(","));
        }
      }

      const csvString = csvRows.join("\n");
      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "tracker_simple.csv");
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
